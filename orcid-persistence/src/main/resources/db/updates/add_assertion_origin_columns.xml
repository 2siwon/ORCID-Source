<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

	<changeSet author="Tom Demeranville" id="ADD-ASSERTION-ORIGIN-TO-TABLES">
	<!-- All the SourceAwareEntities -->
		<preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="address" columnName="assertion_origin_client_source_id"/>
            </not>
		</preConditions>
	    <addColumn tableName="address">
				<column name="assertion_origin_source_id" type="VARCHAR(19)" />
				<column name="assertion_origin_client_source_id" type="VARCHAR(20)" />
		</addColumn>
	    <addColumn tableName="email">
				<column name="assertion_origin_source_id" type="VARCHAR(19)" />
				<column name="assertion_origin_client_source_id" type="VARCHAR(20)" />
		</addColumn>
	    <addColumn tableName="external_identifier">
				<column name="assertion_origin_source_id" type="VARCHAR(19)" />
				<column name="assertion_origin_client_source_id" type="VARCHAR(20)" />
		</addColumn>
	    <addColumn tableName="group_id_record">
				<column name="assertion_origin_source_id" type="VARCHAR(19)" />
				<column name="assertion_origin_client_source_id" type="VARCHAR(20)" />
		</addColumn>
		<addColumn tableName="notification">
				<column name="assertion_origin_source_id" type="VARCHAR(19)" />
				<column name="assertion_origin_client_source_id" type="VARCHAR(20)" />
		</addColumn>
	    <addColumn tableName="org_affiliation_relation">
				<column name="assertion_origin_source_id" type="VARCHAR(19)" />
				<column name="assertion_origin_client_source_id" type="VARCHAR(20)" />
		</addColumn>
	    <addColumn tableName="other_name">
				<column name="assertion_origin_source_id" type="VARCHAR(19)" />
				<column name="assertion_origin_client_source_id" type="VARCHAR(20)" />
		</addColumn>
	    <addColumn tableName="peer_review">
				<column name="assertion_origin_source_id" type="VARCHAR(19)" />
				<column name="assertion_origin_client_source_id" type="VARCHAR(20)" />
		</addColumn>
	    <addColumn tableName="profile_funding">
				<column name="assertion_origin_source_id" type="VARCHAR(19)" />
				<column name="assertion_origin_client_source_id" type="VARCHAR(20)" />
		</addColumn>
	    <addColumn tableName="profile_keyword">
				<column name="assertion_origin_source_id" type="VARCHAR(19)" />
				<column name="assertion_origin_client_source_id" type="VARCHAR(20)" />
		</addColumn>
	    <addColumn tableName="research_resource">
				<column name="assertion_origin_source_id" type="VARCHAR(19)" />
				<column name="assertion_origin_client_source_id" type="VARCHAR(20)" />
		</addColumn>
	    <addColumn tableName="researcher_url">
				<column name="assertion_origin_source_id" type="VARCHAR(19)" />
				<column name="assertion_origin_client_source_id" type="VARCHAR(20)" />
		</addColumn>
	    <addColumn tableName="work">
				<column name="assertion_origin_source_id" type="VARCHAR(19)" />
				<column name="assertion_origin_client_source_id" type="VARCHAR(20)" />
		</addColumn>		
    </changeSet>
    
    <changeSet author="Tom Demeranville" id="UPDATE-ASSERTION-ORIGIN-CONSTRAINTS" dbms="postgresql">
    <!-- remove these then add back but with  assertion_origin_client_source_id and assertion_origin_source_id
    //researcher_url
    //CONSTRAINT researcher_url_orcid_client_source_unique_key UNIQUE (url, orcid, client_source_id),
    //CONSTRAINT researcher_url_orcid_source_unique_key UNIQUE (url, orcid, source_id)
    //external_identifiers
    CONSTRAINT unique_external_identifiers_allowing_multiple_sources UNIQUE (orcid, external_id_reference, external_id_type, source_id, client_source_id)
     -->
     
		 <preConditions onFail="MARK_RAN">
		    <sqlCheck expectedResult="0">select count (*) from pg_constraint where conname='researcher_url_orcid_source_unique_key'</sqlCheck>
		 </preConditions>		
         <dropUniqueConstraint 
            constraintName="researcher_url_orcid_source_unique_key"
            tableName="researcher_url"/>
         <dropUniqueConstraint 
            constraintName="researcher_url_orcid_client_source_unique_key"
            tableName="researcher_url"/>
         <dropUniqueConstraint 
            constraintName="unique_external_identifiers_allowing_multiple_sources"
            tableName="external_identifier"/>
	</changeSet>
	
	    <changeSet author="Tom Demeranville" id="UPDATE-ASSERTION-ORIGIN-CONSTRAINTS-HSQL" dbms="hsqldb">	
         <dropUniqueConstraint 
            constraintName="researcher_url_orcid_source_unique_key"
            tableName="researcher_url"/>
         <dropUniqueConstraint 
            constraintName="researcher_url_orcid_client_source_unique_key"
            tableName="researcher_url"/>
         <dropUniqueConstraint 
            constraintName="unique_external_identifiers_allowing_multiple_sources"
            tableName="external_identifier"/>
	</changeSet>
    
</databaseChangeLog>