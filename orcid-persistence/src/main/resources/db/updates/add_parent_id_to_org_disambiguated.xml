<!--

    =============================================================================

    ORCID (R) Open Source
    http://orcid.org

    Copyright (c) 2012-2014 ORCID, Inc.
    Licensed under an MIT-Style License (MIT)
    http://orcid.org/open-source-license

    This copyright and license information (including a link to the full license)
    shall be included in its entirety in all copies or substantial portion of
    the software.

    =============================================================================

-->
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">
        
    <changeSet id="ADD-PARENT-SOURCE-ID-TO-ORG-DISAMBIGUATED" author="Will Simpson">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="org_disambiguated" columnName="source_parent_id"/>
            </not>
        </preConditions>
        <addColumn tableName="org_disambiguated">
            <column name="source_parent_id" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>
    
    <changeSet id="ORG-DISAMBIGUATED-SOURCE-PARENT-ID-IDX" author="Will Simpson">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists indexName="org_disambiguated_source_parent_id_idx" tableName="org_disambiguated" />
            </not>
        </preConditions>
        <createIndex 
            indexName="org_disambiguated_source_parent_id_idx"
            tableName="org_disambiguated"
            unique="false">
            <column name="source_parent_id" />
        </createIndex>
    </changeSet>
    
     <changeSet id="ORG-DISAMBIGUATED-DESCENDENT-TYPE" author="Will Simpson" dbms="postgresql">
        <preConditions onFail="MARK_RAN">
            <not>
                <sqlCheck expectedResult="1">SELECT 1 FROM information_schema.user_defined_types WHERE user_defined_type_name = 'org_disambiguated_descendent'</sqlCheck>
            </not>
        </preConditions>
        <sql>CREATE TYPE org_disambiguated_descendent AS (id bigint, source_id varchar, source_parent_id varchar, org_type varchar, name varchar, city varchar, region varchar, country varchar, level varchar);</sql>
    </changeSet>
    
    <changeSet id="ORG-DISAMBIGUATED-DESCENDENT-FUNCTION" author="Will Simpson" dbms="postgresql">
        <createProcedure>
CREATE OR REPLACE FUNCTION find_org_disambiguated_descendents(source_id varchar, source_type varchar) RETURNS SETOF org_disambiguated_descendent
AS $$
SELECT p1.id, p1.source_id, p1.source_parent_id, p1.org_type, p1.name, p1.city, p1.region, p1.country, 'child' AS level FROM org_disambiguated p1
WHERE p1.source_parent_id = $1 AND p1.source_type = $2
UNION
SELECT p2.id, p2.source_id, p2.source_parent_id, p2.org_type, p2.name, p2.city, p2.region, p2.country, 'grandchild' AS level FROM org_disambiguated p1
JOIN org_disambiguated p2 ON p2.source_parent_id = p1.source_id AND p2.source_type = $2
WHERE p1.source_parent_id = $1 AND p1.source_type = $2
UNION
SELECT p3.id, p3.source_id, p3.source_parent_id, p3.org_type, p3.name, p3.city, p3.region, p3.country, 'great grandchild' AS level FROM org_disambiguated p1
JOIN org_disambiguated p2 ON p2.source_parent_id = p1.source_id AND p2.source_type = $2
JOIN org_disambiguated p3 ON p3.source_parent_id = p2.source_id AND p3.source_type = $2
WHERE p1.source_parent_id = $1 AND p1.source_type = $2
UNION
SELECT p4.id, p4.source_id, p4.source_parent_id, p4.org_type, p4.name, p4.city, p4.region, p4.country, 'great great grandchild' AS level FROM org_disambiguated p1
JOIN org_disambiguated p2 ON p2.source_parent_id = p1.source_id AND p2.source_type = $2
JOIN org_disambiguated p3 ON p3.source_parent_id = p2.source_id AND p3.source_type = $2
JOIN org_disambiguated p4 ON p4.source_parent_id = p3.source_id AND p4.source_type = $2
WHERE p1.source_parent_id = $1 AND p1.source_type = $2
UNION 
SELECT p5.id, p5.source_id, p5.source_parent_id, p5.org_type, p5.name, p5.city, p5.region, p5.country, 'great great great grandchild' AS level FROM org_disambiguated p1
JOIN org_disambiguated p2 ON p2.source_parent_id = p1.source_id AND p2.source_type = $2
JOIN org_disambiguated p3 ON p3.source_parent_id = p2.source_id AND p3.source_type = $2
JOIN org_disambiguated p4 ON p4.source_parent_id = p3.source_id AND p4.source_type = $2
JOIN org_disambiguated p5 ON p5.source_parent_id = p4.source_id AND p5.source_type = $2
WHERE p1.source_parent_id = $1 AND p1.source_type = $2
ORDER BY level, source_parent_id, name;
$$ LANGUAGE SQL
IMMUTABLE
RETURNS NULL ON NULL INPUT;     
        </createProcedure>
    </changeSet>
    
</databaseChangeLog>